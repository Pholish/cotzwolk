'use strict';
var winWidth,
	winHeight,
	scrollOffset = 0,
	popuped = false,
	scrollPos = 0,
	animDuration = 400,
	offsetElem = $('header'),
	popupedPos,
	formTitle = '';

$(window).on('load',function() {
	var sto = setTimeout(function() {
		//$('.preloader').fadeOut(500);
		$('.page').trigger('page.activate');
	},1000);
});

$(document).ready(function(){
	
	
	
function is_mobilez() {return (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));};

function fix100vh() {
  var winHeight = $(window).height();
  if ( is_mobilez() ) {
    $('.case-bg').css('min-height', winHeight);
    $('.case-bg-counter').css('min-height', winHeight);
  } 
}; fix100vh();


	
	
		$(".js-go_top").click(function (e) {
		e.preventDefault();
		$("html, body").stop().animate({
			"scrollTop": 0
		}, 500, "swing");
	});
	
	
var matches = window.location.pathname.split('/');
$('header .head-menu-list__link[href="'+matches[1]+'"]').parent().addClass("active");

if (document.location.href.indexOf('services') == -1) {
  // не содержит
} else {
  $('header .head-menu-list__link[data-menu-link="services"]').parent().addClass("active-link");
}

if (document.location.href.indexOf('case') == -1) {
  // не содержит
} else {
  $('header .head-menu-list__link[href="cases.php"]').parent().addClass("active-link");
}


if (document.location.href.indexOf('agency') == -1) {
  // не содержит
} else {
  $('header .head-menu-list__link[href="agency.php"]').parent().addClass("active-link");
}


				$('.js-case-slider').slick({
  dots: false,
  infinite: true,
  speed: 1000,
  autoplay:true,
  autoplaySpeed:1500,
  slidesToShow: 1,
  fade: true,
});

$('.js-slick-prev').click(function(){
	
    $(".js-case-slider").slick('slickPrev');
});

$('.js-slick-next').click(function(){
    $(".js-case-slider").slick('slickNext');
});					
								


	svg4everybody(); // поддержка SVG в старых браузерах
	//popup('request');
	winWidth = $(window).width();
	winHeight = $(window).height();
	scrollPos = $(window).scrollTop();

	$('img[data-src]').each(function() {
		var img = $(this);
		img.attr('src',img.attr('data-src'));
		img.on('load', function() {
			img.removeAttr('data-src');
		});
	});

	/*setTimeout(function() {
		$('.page').trigger('page.activate');
	},2000);*/

	// разделение заголовков на строки
	$('.break-lines').each(function() {
		$(this).attr('data-lines-text',$(this).html());
	});
	$('.break-lines').each(function() {
		var lines = $(this), tagHtml = '';

		$(window).on('resize',function() {
			lines.html(lines.attr('data-lines-text'));
			if (lines.hasClass('break-lines--title') || lines.hasClass('break-lines--article-heading')) {
				tagHtml = '<div class="break-lines__line"><div class="break-lines__inner"><div class="break-lines__text scroll-opacity"></div></div></div>'
			}
			if (lines.hasClass('break-lines--service')) {
				tagHtml = '<div class="break-lines__line"><div class="break-lines__inner"></div></div>'
			}
			lines.splitLines({
				tag:tagHtml
			});
		});
	});

	/* ФОРМИРОВАНИЕ МЕНЮ */
	// переносим все подпункты из верхнего меню в основное
	$('header').after('<div class="menu"><div class="menu__inner"><div class="inner inner--menu"></div></div></div>');
	$('.head-menu-list__link--with-sub').each(function() {
		$(this).addClass('menu-open');
		var submenu = $(this).attr('data-menu-link');
		$(this).next('.menu-block').attr('data-menu-link', submenu).appendTo($('.inner--menu'));
	});

	// копируем пункты из верхнего меню в подменю в основном
	$('.inner--menu').prepend('<div class="menu-block menu-block--entire" data-menu-link="entire"><ul class="menu-list"></ul></div>');
	$('.head-menu-list__link').each(function() {
		var link = $(this).clone();
		link.removeClass('head-menu-list__link').addClass('menu-list__link');
		$('.menu-block[data-menu-link="entire"] .menu-list').append('<li class="menu-list__item"></li>');
		$('.menu-block[data-menu-link="entire"] .menu-list .menu-list__item').last().append(link);
	});

	// обавляем кнопку закрытия
	$('.menu').prepend('<div class="menu__close menu-close"></div>');

	// обавляем кнопку возврата для мобильного меню
	$('.menu').prepend('<div class="menu__prev"></div>');
	/* ФОРМИРОВАНИЕ МЕНЮ - конец */

	/* РАБОТА СТРАНИЦЫ */
	$('.page').each(function() {
		/* ОСНОВНАЯ ЧАСТЬ */
		var page = $(this),
			sections = page.find('.section[data-section-name]'),
			pageActivated,
			pageCurrent = '',
			pageSpy = false,
			pageScrolling = false,
			pageHeader = 'full';

		if (page.hasClass('page--with-spy')) {
			pageSpy = true;
		}

		sections.each(function(ind) {
			$(this).attr('data-section-index',ind+1);
		});

		// добавляем навигатор
		if (pageSpy) {
			page.find('.page-content').prepend('<div class="navigator noselect"><ul class="navigator-nav"></ul></div>');

			var pageNav = page.find('.navigator-nav');

			sections.each(function(ind) {
				var name = $(this).attr('data-section-name'),
					title = $(this).attr('data-section-title');

				pageNav.append('<li class="navigator-nav__item"><a class="navigator-nav__link" data-section-name="'+name+'"></a></li>');
				var link = pageNav.find('.navigator-nav__link').last();
				link.append('<div class="navigator-nav__link-nmbr">'+ (ind + 1) +'</div>');
				if (title) {
					link.append('<div class="navigator-nav__link-text">'+ title +'</div>');
				}
			});

			var pageNavItems = pageNav.find('.navigator-nav__item'),
				pageNavLinks = pageNav.find('.navigator-nav__link');

			pageNavLinks.on('click',function(e) {
				var name = $(this).attr('data-section-name');
				goToSection(name);
				e.preventDefault();
			});
		}

		page.on('page.activate',function() {
			//setTimeout(function() {
				pageActivated = true;
				headerType();
				$(window).trigger('scroll');
				page.addClass('page--loaded');
			//},100);
		});

		// при рейсайзе окна
		$(window).on('scroll resize',function() {
			winWidth = $(window).width();
			winHeight = $(window).height();
			scrollPos = $(window).scrollTop();
			headerType();
			spyCheck(scrollPos);
			scrollAnimate(scrollPos);
		});

		// прокрутка к разделу по внешнему тригеру
		page.on('page.goTo',function(i, target) {
			goToSection(target);
		});

		// прокрутка к разделу
		function goToSection(target) {
			if (pageActivated/* && target != pageCurrent*/) {
				var scrollTarget = getSectionPos(target);
				pageScrolling = true;
			
				if (pageSpy) {
					pageNavItems.removeClass('active');
					$('.navigator-nav__link[data-section-name='+target+']').closest('.navigator-nav__item').addClass('active');
				}
				setCurrent(target);

				$('html, body').animate({scrollTop:scrollTarget}, 500, function() {
					setTimeout(function() {
						pageScrolling = false;
					},30);
				});
			}
		}

		//
		function headerType() {
			if (winWidth > 750) {
				pageHeader = 'full';
				//$('.logo--header').removeClass('logo--show');
			} else {
				pageHeader = 'toggle';
				//$('.logo--header').addClass('logo--show');
			}
		}

		// определение текущего раздела
		function spyCheck(scrolledTo) {
			//if (!pageScrolling) {
				var threshold = parseInt(winHeight * 0.5);
				sections.each(function() {
					var section = $(this),
						sectionHeight = section.outerHeight(),
						sectionName = section.attr('data-section-name'),
						sectionPos = getSectionPos(sectionName);
					if (scrolledTo > sectionPos - threshold && scrolledTo < sectionPos + sectionHeight - threshold) {
						setCurrent(sectionName);
					}
				});
			//}
		}

		// определение текущего раздела
		function setCurrent(section) {
			if (pageActivated/* && section != pageCurrent*/) {
				pageCurrent = section;
				sections.removeClass('active');
				var active = $('.section[data-section-name="'+pageCurrent+'"]');
				active.addClass('active');

				if (pageSpy && !pageScrolling) {
					pageNavItems.removeClass('active');
					$('.navigator-nav__link[data-section-name='+pageCurrent+']').closest('.navigator-nav__item').addClass('active');
				}

				if (pageSpy) {
					if (pageHeader == 'full') {
						if (pageCurrent != 'main') {
							if (!$('.logo--header').hasClass('logo--show')) {
								$('.logo--header').addClass('logo--show');
							}
						} else {
							$('.logo--header').removeClass('logo--show');
						}
					}
				}
			}
		}

		// получение позиции раздела
		function getSectionPos(section) {
			return page.find('.section[data-section-name="'+section+'"]').offset().top - scrollOffset;
		}
		/* ОСНОВНАЯ ЧАСТЬ - конец */

		/* АНИМАЦИЯ ПРИ ПРОКРУТКЕ */
		var anim = page.find('.scroll-animate');
		anim.each(function() {
			$(this).find('.scroll-animate__el').not('.scroll-animate__el--no-delay').each(function(i) {
				$(this).attr('data-animate-delay',i+1);
			});
		});  
		// определение блока для анимации
		function scrollAnimate(scrolledTo) {
			if (pageActivated) {
				var threshold = parseInt(winHeight * 0.5);
				anim.each(function() {
					var block = $(this),
						blockHeight = block.outerHeight(),
						blockPos = block.offset().top - scrollOffset;
					//if (scrolledTo > blockPos - threshold && scrolledTo < blockPos + blockHeight - threshold) {
					if (scrolledTo + winHeight - threshold > blockPos - scrollOffset) {
						if (!block.hasClass('animated')) {
							block.addClass('animate-in animated');
						}
					}
				});
			}
		}
		/* АНИМАЦИЯ ПРИ ПРОКРУТКЕ - конец */

		/* ПРОЗРАЧНОСТЬ ПРИ ПРОКРУТКЕ */
		if (page.hasClass('page--with-opacity')) {
			var opac = $('.scroll-opacity'),
				rate = 0.25, range, rangeT, rangeB;
			
			if (device.desktop()) {
				opac.css('opacity',0.3);

				$(window).on('scroll',function() {
					scrollPos = $(window).scrollTop();
					opac = $('.scroll-opacity');
					scrollOpacity(scrollPos);
				});
				$(window).on('resize',function() {
					winHeight = $(window).height();
					scrollPos = $(window).scrollTop();
					opac = $('.scroll-opacity');
					range = winHeight * rate;
					rangeT = range;
					rangeB = winHeight - range;
					scrollOpacity(scrollPos);
				});
			}

			function scrollOpacity(scrolledTo) {
				opac.each(function() {
					var block = $(this),
						blockPos = block.offset().top,
						blockH = block.outerHeight(),
						blockC = blockH / 2;
					if (!(scrolledTo + winHeight < blockPos || scrolledTo > blockPos + blockH)) {
						var cssopac;
						// верхняя часть экрана
						if (!(scrolledTo + rangeT < blockPos)) {
							//console.log('top');
							cssopac = 1 - ((scrolledTo - 100 - blockPos + range) / range);
							//console.log(cssopac);
						}
						// нижняя часть экрана
						else if (!(scrolledTo + rangeB > blockPos + blockH)) {
							//console.log('bot');
							cssopac = - (range / (scrolledTo - blockPos + range));
							//console.log(cssopac);
						} else {
							cssopac = 1;
						}
						block.css('opacity',cssopac);
					}
				});
			}
		}
		/* ПРОЗРАЧНОСТЬ ПРИ ПРОКРУТКЕ - конец */

		/* РАБОТА МЕНЮ */
		var menu = $('.menu'),
			menuBlocks = menu.find('.menu-block'),
			menuOpened = false,
			menuPrev = '',
			menuCurrent = '',
			menuT1, menuT2, menuT3;

		// при клике на кнопку открытия
		page.on('click', '.menu-open',function() {
			var link = $(this).attr('data-menu-link');
			if (menuCurrent != link) {
				if (!menuOpened) {
					menuOpenFirst(link);
				} else {
					menuOpenSub(link);
				}
				menuOpened = true;
				menuPrev = menuCurrent;
				menuCurrent = link;
			}
			if (link == 'services'){
				$('header .head-menu-list__item').removeClass("active");
				$(this).parent('.head-menu-list__item').addClass("active");
				
			}
		});
		


		// при клике на бургер
		page.on('click', '.menu-toggle',function() {
			var link = $(this).attr('data-menu-link');
			if (!menuOpened) {
				menuOpenFirst(link);
				menuOpened = true;
				menuPrev = menuCurrent;
				menuCurrent = link;
				
							
			
			} else {
				menuClose();
			
			}
		});

		// при клике на стрелку в меню
		page.on('click', '.menu__prev',function() {
			var link = $(this).attr('data-menu-link');
			menuOpenSub(link);
			menuPrev = menuCurrent;
			menuCurrent = link;
			
		
		});

		// при клике на кнопку закрытия
		page.on('click', '.menu-close',function() {
			menuClose();
		});

		$(window).on('resize',function() {
			winWidth = $(window).width();
			defineOpenedMenu();
		});

		// открытие меню
		function menuOpenFirst(link) {
			clearTimeout(menuT1);
			clearTimeout(menuT2);
			var block = menu.find('.menu-block[data-menu-link="'+link+'"]');
			popupedPos = $(window).scrollTop();
			page.addClass('page--content-out');
			if (pageHeader == 'full') {
				$('.menu__prev').attr('data-menu-link','entire');
			}
			$('.bg-animation').trigger('bg:hide');
			$('body').addClass('body--menu-opened');
			menuT1 = setTimeout(function() {
				block.show();
			},500);
			menuT2 = setTimeout(function() {
				$('body').addClass('body--fixed');
				menu.addClass('menu--opened');
				block.addClass('active');
				$('.menu__close').fadeIn(400);
			},600);
		}

		// открытие подменю
		function menuOpenSub(link) {
			clearTimeout(menuT1);
			clearTimeout(menuT2);
			var block = menu.find('.menu-block[data-menu-link="'+link+'"]');
			menuBlocks.removeClass('active');
			if (link == 'entire') {
				$('.menu__prev').attr('data-menu-link','').fadeOut(400);
			}
			menuT1 = setTimeout(function() {
				menuBlocks.hide();
				block.show();
				if (link != 'entire') {
					$('.menu__prev').attr('data-menu-link',menuPrev).fadeIn(400);
				}
			},400);
			menuT2 = setTimeout(function() {
				block.addClass('active');
			},430);
		}

		// закрытие меню
		function menuClose() {
			menuOpened = false;
			clearTimeout(menuT1);
			clearTimeout(menuT2);
			page.addClass('page--content-out');
			$('body').removeClass('body--menu-opened');
			menuBlocks.removeClass('active');
			$('.menu__prev').attr('data-menu-link','').fadeOut(400);
			$('.menu__close').fadeOut(400);
			menuT1 = setTimeout(function() {
				menuBlocks.hide();
				menu.removeClass('menu--opened');
				$('body').removeClass('body--fixed');
				if (device.ios()) {
					$(window).scrollTop(popupedPos);
				}
				page.removeClass('page--content-out');
				$('.bg-animation').trigger('bg:show');
			},400);
			menuCurrent = '';
			menuPrev = '';
			
			$('header .head-menu-list__item').removeClass("active");
			var matches = window.location.pathname.split('/');
			$('header .head-menu-list__link[href="'+matches[1]+'"]').parent().addClass("active");
		}

		//
		function defineOpenedMenu() {
			if (menuOpened) {	
				if (winWidth > 750) {
					if (menuCurrent == 'entire') {
						menuClose();
					}
				} else {
					if (menuCurrent != 'entire') {
						$('.menu__prev').fadeIn();
					}
				}
			}
		}
		/* РАБОТА МЕНЮ - конец */

		/* КАРУСЕЛИ НА ГЛАВНОЙ */
		function initDestroySliders() {
			var sliders = $('.clients-slider, .ratings-slider, .awards-slider, .news-slider');

			sliders.each(function() {
				var slider = $(this),
					sliderOptions = {loop:true,nav:true,navText:['',''],items:4};

				if (slider.hasClass('clients-slider')) {
					sliderOptions.items = 6;
					sliderOptions.autoWidth = true;
					sliderOptions.margin = 60;
					sliderOptions.responsive = {
						0: {
							margin:50
						},
						1400: {
							margin:60
						},
						1700: {
							margin:70
						},
						2100: {
							margin:80
						}
					}
					//sliderOptions.onInitialized = clientsSize();
					//sliderOptions.onTranslated = clientsSize();
				} 
				if (slider.hasClass('news-slider')) {
					sliderOptions.items = 3;
				}
				$(window).on('resize',function() {
					winWidth = $(window).width();
					winHeight = $(window).height();
					if (winWidth > 1050) {
						if (!slider.hasClass('owl-carousel')) {
							if (slider.hasClass('clients-slider')) {
								slider.on('initialized.owl.carousel',function() {
									clientsSize();
								});
								slider.on('translated.owl.carousel',function() {
									clientsSize();
								});
								$(window).on('resize',function() {
									clientsSize();
								});
							}
							slider.addClass('owl-carousel').owlCarousel(sliderOptions);
							slider.on('translate.owl.carousel',function() {
								$(window).trigger('scroll');
							});
						}
					} else {
						if (slider.hasClass('owl-carousel')) {
							slider.trigger('destroy.owl.carousel').removeClass('owl-carousel');
						}
					}
				});
			});
		}
		initDestroySliders();

		function clientsSize() {
			$('.clients-slider').width($('.content--clients').width());
			var els = $('.clients-slider .owl-item.active'),
				elsM = +$('.clients-slider .owl-item.active').first().css('margin-right').slice(0,-2),
				elsW = 0;

			els.each(function(i) {
				if (i < 6) {
					elsW += $(this).width();
					//console.log(i, $(this).width());
				}
			});
			elsW += (elsM*5) + 1;
			//setTimeout(function() {
				$('.clients-container').width(elsW);
				if (elsW > $('.content--clients').width()) {
					$('.clients-slider').width(elsW);
				}
			//},30);
			//console.log(elsW);
		}
		/* КАРУСЕЛИ НА ГЛАВНОЙ - конец */
	});
	/* РАБОТА СТРАНИЦЫ - конец */
	
	
	
	



	
/* 
	$('.service').each(function() {
		var service = $(this),
			serviceFilters = service.find('.service-item'),
			serviceBricks = service.find('.service-bricks');

		serviceFilters.on('click',function() {
			var filt;

			if (!$(this).hasClass('active')) {
				filt = $(this).attr('data-filter');
				serviceFilters.removeClass('active');
				$(this).addClass('active');

				$('html, body').animate({scrollTop:serviceBricks.offset().top - 20},500);
			} else {
				serviceFilters.removeClass('active');
				filt = '.service-brick';
			}

			serviceBricks.isotope({
				filter:filt
			});
		});

		serviceBricks.isotope({
			itemSelector:'.service-brick',
			percentPosition:true,
			masonry: {
				columnWidth:'.service-brick-sizer',
				gutter:20
			}
		});
	});
*/

	/*$('.main').each(function() {
		var main = $(this),
			block = main.find('.main-video'),
			vid = block.find('video').get(0);

		main.find('.main-view').on('click',function() {
			$('.page').trigger('page.goTo','main');
			$('body').addClass('body--main-video-view');
			vid.play();
		});

		main.find('.main-video__close').on('click',function() {
			$('body').removeClass('body--main-video-view');
			vid.pause();
		});
	});*/

	// Прокрутка к разделу
	$('.scrollToSection').on('click',function(e) {
		e.preventDefault();
		var target = $(this).attr('data-section-name');
		if ($('.section[data-section-name="'+target+'"]').length) {
			if ($('.page').hasClass('page--with-spy')) {
				$('.page').trigger('page.goTo',target);
			} else {
				var targetPos = $('.section[data-section-name="'+target+'"]').offset().top - scrollOffset;
				$('html, body').animate({scrollTop:targetPos},500);
			}
		}
	});

	$(window).on('resize',function() {
		winWidth = $(window).width();
		winHeight = $(window).height();
		scrollPos = $(window).scrollTop();
	});
	$(window).on('scroll',function() {
		scrollPos = $(window).scrollTop();
	});

	$(window).trigger('resize');
	$(window).trigger('scroll');

	if (device.desktop()) {
		
	} else {
		
	}

	// Добавляем текст ошибок для полей
	$('.form--validate').each(function() {
		var form = $(this);
		form.find('.form__field').each(function() {
			$(this).append('<div class="form-errors" />');
		});
		form.find('.form__field--required').find('.form-errors').append('<p class="form-errors__item form-errors__item-required">Обязательное поле</p>');
	});

	// Добавляем * для всех обязательных к заполнению полей
	$('.form--validate').find('.form__field--required').each(function() {
		$(this).find('.placeholder').append(' *');
	});

	// РАБОТА С ИНПУТАМИ

	// "Плавающий" placeholder
	$('.label--input').each(function() {
		var label = $(this);
		var input = $(this).find('input, textarea');
		var field = $(this).closest('.form__field');

		// фокус на инпуте/тексэйрии
		input.on('focus',function() {
			label.addClass('active focused');
		}).on('focusout blur change keyup input', function() {
			var value = $(this).val();
			if (value == '') {
				if (!input.is(':focus')) {
					label.removeClass('active');
				}
			} else {
				label.addClass('active');
				field.removeClass('form__field--error');
			}
		}).on('focusout',function() {
			label.removeClass('focused');
		});
	});

	// Отправка формы по нажатию на Enter (при фокусе на input или textarea)
	$('.form--enter').find('input').on('focus',function() {
		$(this).closest('.form--enter').addClass('focused');
	}).on('blur',function() {
		$(this).closest('.form--enter').removeClass('focused');
	});
	$('.form--enter').find('input').on('focus',function() {
		var form = $(this).closest('.form--enter');
		var btn = form.find('.btn--enter');
		$(document).keydown(function(e) {
			if (form.hasClass('focused')) {
				if (e.which == 13) {
					btn.trigger('click');
				}
			}
		});
	});

	// Ограничение длины ввода в поле type="number"
	$('input[type="number"]').on('input change paste keyup',function() {
		var max = parseInt($(this).attr('data-max'));
		var val = $(this).val();
		if (val.length > max) {
			$(this).val(val.slice(0,max));
		}
	});

	// Запрет ввода любых символов, кроме 0-9, (), -, +
	$('input.input-phone_number, .form-validate .form__field[data-field-type="phone"] input').on('input change paste keyup',function() {
		$(this).val(this.value.replace(/[^0-9\+ ()\-]/,''));
	});

	// Прокрутка к элементу
	$('.scrollTo').on('click',function(e) {
		e.preventDefault();
		var target = $(this).attr('data-scrollto');
		if (target) {
			var targetPos = $('[data-scrollto="'+target+'"]').not($(this)).offset().top - scrollOffset;
			$('html, body').animate({scrollTop:targetPos},500);
		}
	});

	// ТАБЫ
	$('.tab-content').hide();
	$('ul.tabs').each(function() {
		if ($(this).find('li.active').length < 1 || $(this).find('li.active').length > 1) {
			$(this).find('li').removeClass('active');
			$(this).find('li:first-child').addClass('active');
		}
		var activeTab = $(this).find('li.active');
		var activeTabContent = activeTab.find('a').attr('data-tab');
		$('.tab-content[data-tab="'+activeTabContent+'"]').show();
	});
	$('ul.tabs').find('a').on('click',function() {
		if (!$(this).closest('li').hasClass('active')) {
			var tab = $(this).attr('data-tab');

			$(this).closest('ul').find('li').removeClass('active');
			$(this).closest('li').addClass('active');

			$('.tab-content[data-tab="'+tab+'"]').parent().find('.tab-content').hide();
			$('.tab-content[data-tab="'+tab+'"]').fadeIn(animDuration);
		}
	});

	// АККОРДИОНЫ
	$('ul.accordion').not('.collapsed').each(function() {
		if ($(this).find('li.active').length < 1 || $(this).find('li.active').length > 1) {
			$(this).find('li').removeClass('active');
			$(this).find('li').first().addClass('active');
		}
	});
	$('ul.accordion').find('li').not('.active').each(function() {
		$(this).find('.panel').hide();
	});
	$('ul.accordion').find('li').find('h6').on('click',function() {
		var panel = $(this).closest('li');
		var panels = $(this).closest('ul').find('li');
		if (!panel.hasClass('active')) {

			$(this).closest('ul.accordion').find('.panel').hide();
			var panelPos = panel.offset().top - scrollOffset;
			$(this).closest('ul.accordion').find('li.active').find('.panel').show();
			setTimeout(function() {
				$('html, body').animate({scrollTop:panelPos},animDuration);

				panels.removeClass('active');
				panel.addClass('active');

				panels.find('.panel').slideUp(animDuration);
				panel.find('.panel').slideDown(animDuration);
			},1);
		}
		else {
			panel.removeClass('active');
			panels.find('.panel').slideUp(animDuration);
		}
	});

	// Youtube fix
	$('iframe').each(function() {
		var ifr_source=$(this).attr('src');
		var wmode="wmode=transparent";
		if(ifr_source.indexOf('?')!=-1) {
			var getQString=ifr_source.split('?');
			var oldString=getQString[1];
			var newString=getQString[0];
			$(this).attr('src',newString+'?'+wmode+'&'+oldString)
		} else $(this).attr('src',ifr_source+'?'+wmode)
	});

	// Добавляем в попап кнопку закрытия
	$('.popup__content').each(function() {
		$(this).prepend('<div class="popup__close noselect" />');
	});
	$('.popup__close').on('click',function() {
		popupClose();
	});

	// Закрытие попапа при клике на фон
	$('.popup').on('click',function(e){
		if ($(e.target).closest('.popup__content').length) {} 
		else {
			popupClose();
			e.stopPropagation();
		}
	});

	// Закрытие попапа по нажатию на Esc
	$(document).keydown(function(e) {
		if (popuped = true) {
			if (e.which == 27) {
				popupClose();
			}
		}
	});

	// ОТПРАВКА ДАННЫХ ИЗ ФОРМЫ
	$('.btn--sendform').on('click',function() {
		var formBtn = $(this),
			form = $(this).closest('form'),
			valid = formValidator(form.get(0)),
			submit = $(this).attr('data-form-type');
		if (valid != false) {
			var formData = new FormData(form.get(0)),
				thxPopup = formBtn.attr('data-thxpopup') || 'thx';
			if (!formTitle) {
				formTitle = 'Заявка';
			}
			formData.append('formTitle', formTitle);
			formData.append('submit', submit);
			$.ajax({
				type: 'POST',
				url: rootPath+'php/send.php',
				dataType: 'json',
				processData: false,
				contentType: false,
				data: formData,
				success: function() {
					thx(thxPopup);
					//метрики
					//setTimeout(function(){ga('send', 'event', ''+submit, ''+submit);}, 30);
					//setTimeout(function(){yaCounterXXXXXXXXX.reachGoal(''+submit);}, 30); // меняем XXXXXXXXX на номер счетчика
				},
				error: function() {
					console.log(data);
				}
			});
		} else {
			form.find('.form__field-error').first().find('input, textarea').focus();
		}
	});

});

	


// ПОПАПЫ
// Открытие попапа
function popup(id, form, h1, h2, btn) {
	popupedPos = $(window).scrollTop();
	$('body').addClass('body--popuped');
	$('.popups-overlay').fadeIn(animDuration);
	$('.popup').removeClass('active').fadeOut(animDuration);
	var popup = $('.popup#'+id);

	if (id == 'request') {
		var defH1 = 'Оставить заявку',
			defH2 = 'Оставьте заявку, и&nbsp;наш специалист свяжется с&nbsp;вами в&nbsp;ближайшее время',
			defBtn = 'Оставить заявку';
		if (h1) {popup.find('.popup__h1').html(h1);} else {popup.find('.popup__h1').html(defH1);}
		if (h2) {popup.find('.popup__h2').html(h2);} else {popup.find('.popup__h2').html(defH2);}
		if (btn) {popup.find('.btn').html(btn);} else {popup.find('.btn').html(defBtn);}
		if (form) {formTitle = form;}
	}
	popup.addClass('active').fadeIn(animDuration).scrollTop(0);
	popuped = true;
}
// Открытие попапа с видео
function videoPopup(id, videoUrl) {
	popupedPos = $(window).scrollTop();
	$('body').addClass('body--popuped');
	$('.popups-overlay').fadeIn(animDuration);
	$('.popup').removeClass('active').fadeOut(animDuration);
	var popup = $('.popup--video#'+id);
	popup.find('.popup_video').html('<iframe src="'+videoUrl+'" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>');
	popup.addClass('active').fadeIn(animDuration).scrollTop(0);
	popuped = true;
}
// Открытие попапа с фото

$('.js-show_big').click(function(e){
	e.preventDefault();
	//var foto = $(this).html();
	var foto = $(this).attr('href');
	popupedPos = $(window).scrollTop();
	$('body').addClass('body--popuped');
	$('.popups-overlay').fadeIn(animDuration);
	$('.popup').removeClass('active').fadeOut(animDuration);
	var popup = $('.popup#foto');
	popup.find('.popup__content_foto').html('<img src="'+foto+'">');
	
	
	popup.addClass('active').fadeIn(animDuration).scrollTop(0);
	popuped = true;
});
// Закрытие попапа
function popupClose() {
	$('.popups-overlay').fadeOut(animDuration);
	$('.popup').removeClass('active').fadeOut(animDuration, function() {$('body').removeClass('body--popuped')});
	if (device.ios()) {
		$(window).scrollTop(popupedPos);
	}
	$('.popup_video').html('');
	$('.popup').find('.form__field').removeClass('form__field--error');
	$('.popup').find('.form__field').find('input, textarea').val('').trigger('change');
	popuped = false;
}

// Попап "Спасибо за заявку"
function thx(thx) {
	$('.popup').removeClass('active').fadeOut(animDuration);
	if (!thx) {
		thx = 'thx';
	}
	popup(thx);
	$('body').find('.form__field--error').removeClass('form__field--error');
	$('body').find('textarea, input').val('').trigger('change');
}

// Изменяем formTitle для формы
function changeFormTitle(form) {
	formTitle = form;
}

// Валидатор формы
function formValidator(form) {
	var $form = $(form);
	var valid = true;

	if ($form.find('.form__field--required').length) {
		$form.find('.form__field--required').each(function() {
			var errorClass = 'form__field--error';
			var type = $(this).attr('data-field-type');
			var val;
			if ($(this).find('input').length) {
				val = $(this).find('input').val();
			} else {
				val = $(this).find('textarea').val();
			}

			if (!val) {
				$(this).addClass(errorClass);
				$(this).find('.form-errors__item--type').remove();
				$(this).find('.form-errors__item--required').show();
				valid = false;
			} else {
				$(this).removeClass(errorClass);
				$(this).find('.form-errors__item--required').hide();

				if (type == 'email') {
					var errorText = 'Неверный формат e-mail';
					if(!/^[\.A-z0-9_\-\+]+[@][A-z0-9_\-]+([.][A-z0-9_\-]+)+[A-z]{1,4}$/.test(val)) {
						$(this).find('.form-errors').append('<p class="form-errors__item--type">'+errorText+'</p>');
						$(this).addClass(errorClass);
						valid = false;
					} else {
						$(this).find('.form-errors_item--type').remove();
						$(this).removeClass(errorClass);
					}
				}

				if (type == 'phone') {
					var errorText = 'Неверный формат номера телефона';
					if(/[^0-9\+ ()\-]/.test(val)) {
						$(this).find('.form-errors').append('<p class="form-errors__item--type">'+errorText+'</p>');
						$(this).addClass(errorClass);
						valid = false;
					} else {
						$(this).find('.form-errors__item--type').remove();
						$(this).removeClass(errorClass);
					}
				}
			}
		});
	}

	if(valid != true) { return false; }
}
//(function(){var script=document.createElement('script');script.onload=function(){var stats=new Stats();document.body.appendChild(stats.dom);requestAnimationFrame(function loop(){stats.update();requestAnimationFrame(loop)});};script.src='https://rawgit.com/mrdoob/stats.js/master/build/stats.min.js';document.head.appendChild(script);})()